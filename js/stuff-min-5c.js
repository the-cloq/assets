let currentChartMode=localStorage.getItem("viewMode")||"time";function updateChart(e){const t=document.querySelector(".bar-container"),n=t.querySelector(".bar-track-wrapper");n.innerHTML="";const a=document.querySelector(".touch-line"),o=document.querySelector(".floating-uptime-label"),r=document.querySelector(".static-uptime-label");r.querySelector(".uptime-title").textContent="Today";const i=o.querySelector(".uptime-title"),s=o.querySelector(".uptime-value"),l=r.querySelector(".uptime-value"),c=document.querySelector(".summary-uptime"),d=document.getElementById("status-text"),u=document.querySelector(".bar-chart-wrapper"),m=1.4*Math.max(...e.days,1),h=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],p=new Date,y=[],f=e.days[6],v=Math.floor(f/60),g=f%60,b=f/60*.00375,C=document.getElementById("priceperkwh"),M=parseFloat(C?.value||.27);l.textContent="time"===currentChartMode?`${v}h ${g}m`:formatCost(b*M);for(let e=6;e>=0;e--){const t=new Date;t.setDate(p.getDate()-e),y.push(h[t.getDay()])}e.days.forEach(((e,t)=>{const a=document.createElement("div");a.className="bar",a.style.height="0%",a.style.transition="height 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)",a.dataset.index=t,a.dataset.uptime=e,a.style.backgroundColor=0===e?"#4a558e":6===t?"#7349ff":"#00ffff";const o=document.createElement("div");o.className="bar-label",o.textContent=y[t],a.appendChild(o),n.appendChild(a),setTimeout((()=>{const t=Math.max(1,e/m*100),n=1.05*t;a.style.height=`${n}%`,setTimeout((()=>{a.style.transition="height 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)",a.style.height=`${t}%`}),300)}),30+100*t)}));setTimeout((()=>requestAnimationFrame(insertWeekDivider)),1100);const S=Number(e.thisWeek)||0,x=Number(e.lastWeek)||0,D=e.days.slice(-7),E=D.reduce(((e,t)=>e+t),0)/D.length,k=S/60*.00375,T=E/60*.00375,$=x/60*.00375;function q(e){e=Math.round(e);const t=Math.floor(e/60),n=e%60;return t>0?`${t}h ${n}m`:`${n}m`}if(c.innerHTML="time"===currentChartMode?`\n        <div class="uptime-left"><span>This Week</span><br>${q(S)}</div>\n        <div class="uptime-center"><span>Daily Avg</span><br>${q(E)}</div>\n        <div class="uptime-right"><span>Last Week</span><br>${q(x)}</div>\n      `:`\n        <div class="uptime-left"><span>This Week</span><br>${formatCost(k*M)}</div>\n        <div class="uptime-center"><span>Daily Avg</span><br>${formatCost(T*M)}</div>\n        <div class="uptime-right"><span>Last Week</span><br>${formatCost($*M)}</div>\n      `,e.weeklyMsg){const t=document.getElementById("weekly-toast");t&&(t.textContent=e.weeklyMsg,t.style.display="block",t.style.opacity="1",setTimeout((()=>{t.style.opacity="0",setTimeout((()=>{t.style.display="none"}),600)}),4e3))}function L(e){const n=Array.from(t.querySelectorAll(".bar")),l=t.getBoundingClientRect(),c=Math.max(5,Math.min(e-l.left,t.offsetWidth-5));a.style.left=`${c}px`,a.style.display="block";const d=o.offsetWidth;let m=Math.max(0,Math.min(c-d/2,u.offsetWidth-d));o.style.left=`${m}px`,o.style.display="flex",r.style.opacity="0";let h=null,p=1/0;if(n.forEach((t=>{const n=t.getBoundingClientRect().left+t.offsetWidth/2,a=Math.abs(n-e);a<p&&(p=a,h=t)})),h){const e=parseInt(h.dataset.uptime,10),t=parseInt(h.dataset.index,10);i.textContent=6===t?"Today":y[t];const n=e/60*.00375*M;s.textContent="time"===currentChartMode?`${Math.floor(e/60)}h ${e%60}m`:formatCost(n),t!==lastTouchedIndex&&(navigator.vibrate&&navigator.vibrate(10),lastTouchedIndex=t)}}d.innerHTML="<span>Energy Saving:</span> "+(E<=180?"Excellent":E<=360?"Good":"Bad"),d.style.color=E<=180?"#FFFFFF":E<=360?"#FFD700":"#FF0000",t.addEventListener("touchstart",(e=>{startX=e.touches[0].clientX,startY=e.touches[0].clientY,dragStarted=!1,isDragging=!1}),{passive:!0}),t.addEventListener("touchmove",(e=>{const t=e.touches[0].clientX-startX,n=e.touches[0].clientY-startY;if(!dragStarted){if(Math.abs(n)>Math.abs(t))return void(isDragging=!1);isDragging=!0,dragStarted=!0}isDragging&&(e.preventDefault(),L(e.touches[0].clientX))}),{passive:!1}),t.addEventListener("touchend",(()=>{isDragging=!1,dragStarted=!1,o.style.display="none",r.style.opacity="1",a.style.display="none"})),t.addEventListener("mousemove",(e=>L(e.clientX))),t.addEventListener("mouseleave",(()=>{o.style.display="none",r.style.opacity="1",a.style.display="none"}))}function insertWeekDivider(){const e=document.querySelector(".bar-container"),t=e.querySelectorAll(".bar"),n=(6-(new Date).getDay()+7)%7;if(e.querySelectorAll(".week-divider").forEach((e=>e.remove())),t[n]){const a=document.createElement("div");a.className="week-divider";const o=Math.max(0,t[n].offsetLeft-5);a.style.left=`${o}px`,e.appendChild(a)}}function formatCost(e){return`${(100*e).toFixed(1)}p`}function fetchUptimeData(){const e=document.getElementById("chart-spinner");e.style.display="block",fetch("/uptime-data").then((e=>e.json())).then((e=>{updateChart(e)})).finally((()=>{e.style.display="none"}))}function resetUptime(){fetch("/reset-uptime",{method:"POST"}).then((()=>{fetchUptimeData(),alert("Uptime history has been reset!")})).catch((e=>{console.error("Reset failed:",e),alert("Failed to reset uptime.")}))}document.querySelectorAll('input[name="view-mode"]').forEach((e=>{e.value===currentChartMode&&(e.checked=!0),e.addEventListener("change",(()=>{currentChartMode=document.querySelector('input[name="view-mode"]:checked').value,localStorage.setItem("viewMode",currentChartMode),fetchUptimeData()}))})),document.addEventListener("DOMContentLoaded",(()=>{fetchUptimeData(),setInterval(fetchUptimeData,6e4)})),document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("panel5");if(!e)return;new MutationObserver((()=>{"false"===e.getAttribute("aria-hidden")&&insertWeekDivider()})).observe(e,{attributes:!0})})),document.getElementById("freshRolloverBtn").addEventListener("click",(()=>{const e=document.getElementById("rolloverStatus");e.textContent="⏳ Triggering...",fetch("/force-rollover",{method:"POST"}).then((()=>{e.textContent="✅ Rollover complete",setTimeout((()=>e.textContent=""),3e3)})).catch((t=>{console.error("❌ Rollover failed:",t),e.textContent="❌ Rollover failed"}))}));
