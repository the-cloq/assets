let currentChartMode=localStorage.getItem("viewMode")||"time";function updateChart(e){const t=document.querySelector(".bar-container"),n=document.querySelector(".touch-line"),a=document.querySelector(".floating-uptime-label"),o=document.querySelector(".static-uptime-label");o.querySelector(".uptime-title").textContent="Today";const s=a.querySelector(".uptime-title"),i=a.querySelector(".uptime-value"),r=o.querySelector(".uptime-value"),l=document.querySelector(".summary-uptime"),c=document.getElementById("status-text"),d=document.querySelector(".bar-chart-wrapper"),u=1.4*Math.max(...e.days,1),h=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],m=new Date,p=[],y=e.days[6],f=Math.floor(y/60),v=y%60,g=y/60*.00375,b=document.getElementById("priceperkwh"),C=parseFloat(b?.value||.27);r.textContent="time"===currentChartMode?`${f}h ${v}m`:formatCost(g*C);let M=!1,S=0,x=0;for(let e=6;e>=0;e--){const t=new Date;t.setDate(m.getDate()-e),p.push(h[t.getDay()])}const E=t.querySelectorAll(".bar");7===E.length?e.days.forEach(((e,t)=>{const n=E[t],a=parseInt(n.dataset.uptime||"0",10),o=Math.max(1,e/u*100);if(e!==a){const e=1.05*o;n.style.transition="height 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)",setTimeout((()=>{n.style.height=`${e}%`,setTimeout((()=>{n.style.transition="height 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)",n.style.height=`${o}%`}),300)}),100*t)}else n.style.height=`${o}%`;n.dataset.uptime=e})):(t.innerHTML="",e.days.forEach(((e,n)=>{const a=document.createElement("div");a.className="bar",a.style.height="0%",a.style.transition="height 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)",a.dataset.index=n,a.dataset.uptime=e,a.style.backgroundColor=0===e?"#4a558e":6===n?"#7349ff":"#00ffff";const o=document.createElement("div");o.className="bar-label",o.textContent=p[n],a.appendChild(o),t.appendChild(a),setTimeout((()=>{const t=Math.max(1,e/u*100),n=1.05*t;a.style.height=`${n}%`,setTimeout((()=>{a.style.transition="height 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)",a.style.height=`${t}%`}),300)}),30+100*n)})));const T=Number(e.thisWeek)||0,$=Number(e.lastWeek)||0,k=T/7,D=T/60*.00375,q=k/60*.00375,F=$/60*.00375;function I(e){e=Math.round(e);const t=Math.floor(e/60),n=e%60;return t>0?`${t}h ${n}m`:`${n}m`}if(l.innerHTML="time"===currentChartMode?`\n    <div class="uptime-left"><span>This Week</span><br>${I(T)}</div>\n    <div class="uptime-center"><span>Daily Avg</span><br>${I(k)}</div>\n    <div class="uptime-right"><span>Last Week</span><br>${I($)}</div>\n  `:`\n    <div class="uptime-left"><span>This Week</span><br>${formatCost(D*C)}</div>\n    <div class="uptime-center"><span>Daily Avg</span><br>${formatCost(q*C)}</div>\n    <div class="uptime-right"><span>Last Week</span><br>${formatCost(F*C)}</div>\n  `,e.weeklyMsg){const t=document.getElementById("weekly-toast");t&&(t.textContent=e.weeklyMsg,t.style.display="block",t.style.opacity="1",setTimeout((()=>{t.style.opacity="0",setTimeout((()=>{t.style.display="none"}),600)}),4e3))}function L(e){const r=Array.from(t.querySelectorAll(".bar")),l=t.getBoundingClientRect(),c=Math.max(5,Math.min(e-l.left,t.offsetWidth-5));n.style.left=`${c}px`,n.style.display="block";const u=a.offsetWidth;let h=Math.max(0,Math.min(c-u/2,d.offsetWidth-u));a.style.left=`${h}px`,a.style.display="flex",o.style.opacity="0";let m=null,y=1/0;if(r.forEach((t=>{const n=t.getBoundingClientRect().left+t.offsetWidth/2,a=Math.abs(n-e);a<y&&(y=a,m=t)})),m){const e=parseInt(m.dataset.uptime,10),t=parseInt(m.dataset.index,10);s.textContent=6===t?"Today":p[t];const n=e/60*.00375*C;i.textContent="time"===currentChartMode?`${Math.floor(e/60)}h ${e%60}m`:formatCost(n),t!==lastTouchedIndex&&(navigator.vibrate&&navigator.vibrate(10),lastTouchedIndex=t)}}c.innerHTML="<span>Energy Saving:</span> "+(k<=90?"Excellent":k<=240?"Good":"Bad"),c.style.color=k<=90?"#FFFFFF":k<=240?"#FFD700":"#FF0000",t.addEventListener("touchstart",(e=>{S=e.touches[0].clientX,x=e.touches[0].clientY,dragStarted=!1,M=!1}),{passive:!0}),t.addEventListener("touchmove",(e=>{const t=e.touches[0].clientX-S,n=e.touches[0].clientY-x;if(!dragStarted){if(Math.abs(n)>Math.abs(t))return void(M=!1);M=!0,dragStarted=!0}M&&(e.preventDefault(),L(e.touches[0].clientX))}),{passive:!1}),t.addEventListener("touchend",(()=>{M=!1,dragStarted=!1,a.style.display="none",o.style.opacity="1",n.style.display="none"})),t.addEventListener("mousemove",(e=>L(e.clientX))),t.addEventListener("mouseleave",(()=>{a.style.display="none",o.style.opacity="1",n.style.display="none"}))}function formatCost(e){return`${(100*e).toFixed(1)}p`}function fetchUptimeData(){const e=document.getElementById("chart-spinner");e.style.display="block",fetch("/uptime-data").then((e=>e.json())).then((e=>{updateChart(e)})).finally((()=>{e.style.display="none"}))}function resetUptime(){fetch("/reset-uptime",{method:"POST"}).then((()=>{fetchUptimeData(),alert("Uptime history has been reset!")})).catch((e=>{console.error("Reset failed:",e),alert("Failed to reset uptime.")}))}document.querySelectorAll('input[name="view-mode"]').forEach((e=>{e.value===currentChartMode&&(e.checked=!0),e.addEventListener("change",(()=>{currentChartMode=document.querySelector('input[name="view-mode"]:checked').value,localStorage.setItem("viewMode",currentChartMode),fetchUptimeData()}))})),document.addEventListener("DOMContentLoaded",(()=>{fetchUptimeData(),setInterval(fetchUptimeData,6e4)})),document.getElementById("freshRolloverBtn").addEventListener("click",(()=>{const e=document.getElementById("rolloverStatus");e.textContent="⏳ Triggering...",fetch("/force-rollover",{method:"POST"}).then((()=>{e.textContent="✅ Rollover complete",setTimeout((()=>e.textContent=""),3e3)})).catch((t=>{console.error("❌ Rollover failed:",t),e.textContent="❌ Rollover failed"}))}));
