let currentChartMode=localStorage.getItem("viewMode")||"time";function updateChart(e){const t=document.querySelector(".bar-container"),n=t.querySelector(".bar-track-wrapper");n.innerHTML="";const a=document.querySelector(".touch-line"),o=document.querySelector(".floating-uptime-label"),s=document.querySelector(".static-uptime-label");s.querySelector(".uptime-title").textContent="Today";const r=o.querySelector(".uptime-title"),i=o.querySelector(".uptime-value"),l=s.querySelector(".uptime-value"),c=document.querySelector(".summary-uptime"),d=document.getElementById("status-text"),u=document.querySelector(".bar-chart-wrapper"),m=1.4*Math.max(...e.days,1),h=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],y=new Date,p=[],f=e.days[6],v=Math.floor(f/60),g=f%60,b=f/60*.00375,C=document.getElementById("priceperkwh"),M=parseFloat(C?.value||.27);l.textContent="time"===currentChartMode?`${v}h ${g}m`:formatCost(b*M);let S=!1,x=0,E=0;for(let e=6;e>=0;e--){const t=new Date;t.setDate(y.getDate()-e),p.push(h[t.getDay()])}const T=t.querySelectorAll(".bar");if(7===T.length)e.days.forEach(((e,t)=>{const n=T[t],a=parseInt(n.dataset.uptime||"0",10),o=Math.max(1,e/m*100);if(e!==a){const e=1.05*o;n.style.transition="height 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)",setTimeout((()=>{n.style.height=`${e}%`,setTimeout((()=>{n.style.transition="height 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)",n.style.height=`${o}%`}),300)}),100*t)}else n.style.height=`${o}%`;n.dataset.uptime=e}));else{t.innerHTML="",e.days.forEach(((e,t)=>{const a=document.createElement("div");a.className="bar",a.style.height="0%",a.style.transition="height 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)",a.dataset.index=t,a.dataset.uptime=e,a.style.backgroundColor=0===e?"#4a558e":6===t?"#7349ff":"#00ffff";const o=document.createElement("div");o.className="bar-label",o.textContent=p[t],a.appendChild(o),n.appendChild(a),setTimeout((()=>{const t=Math.max(1,e/m*100),n=1.05*t;a.style.height=`${n}%`,setTimeout((()=>{a.style.transition="height 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)",a.style.height=`${t}%`}),300)}),30+100*t)}));const a=(6-(new Date).getDay()+7)%7,o=n.querySelectorAll(".bar");if(o[a]){const e=document.createElement("div");e.className="week-divider",e.style.position="absolute",e.style.top="0",e.style.bottom="0",e.style.width="2px",e.style.backgroundColor="rgba(255, 255, 255, 0.2)",e.style.left=o[a].offsetLeft+"px",n.appendChild(e)}}const $=Number(e.thisWeek)||0,k=Number(e.lastWeek)||0,D=$/7,q=$/60*.00375,L=D/60*.00375,w=k/60*.00375;function F(e){e=Math.round(e);const t=Math.floor(e/60),n=e%60;return t>0?`${t}h ${n}m`:`${n}m`}if(c.innerHTML="time"===currentChartMode?`\n    <div class="uptime-left"><span>This Week</span><br>${F($)}</div>\n    <div class="uptime-center"><span>Daily Avg</span><br>${F(D)}</div>\n    <div class="uptime-right"><span>Last Week</span><br>${F(k)}</div>\n  `:`\n    <div class="uptime-left"><span>This Week</span><br>${formatCost(q*M)}</div>\n    <div class="uptime-center"><span>Daily Avg</span><br>${formatCost(L*M)}</div>\n    <div class="uptime-right"><span>Last Week</span><br>${formatCost(w*M)}</div>\n  `,e.weeklyMsg){const t=document.getElementById("weekly-toast");t&&(t.textContent=e.weeklyMsg,t.style.display="block",t.style.opacity="1",setTimeout((()=>{t.style.opacity="0",setTimeout((()=>{t.style.display="none"}),600)}),4e3))}function I(e){const n=Array.from(t.querySelectorAll(".bar")),l=t.getBoundingClientRect(),c=Math.max(5,Math.min(e-l.left,t.offsetWidth-5));a.style.left=`${c}px`,a.style.display="block";const d=o.offsetWidth;let m=Math.max(0,Math.min(c-d/2,u.offsetWidth-d));o.style.left=`${m}px`,o.style.display="flex",s.style.opacity="0";let h=null,y=1/0;if(n.forEach((t=>{const n=t.getBoundingClientRect().left+t.offsetWidth/2,a=Math.abs(n-e);a<y&&(y=a,h=t)})),h){const e=parseInt(h.dataset.uptime,10),t=parseInt(h.dataset.index,10);r.textContent=6===t?"Today":p[t];const n=e/60*.00375*M;i.textContent="time"===currentChartMode?`${Math.floor(e/60)}h ${e%60}m`:formatCost(n),t!==lastTouchedIndex&&(navigator.vibrate&&navigator.vibrate(10),lastTouchedIndex=t)}}d.innerHTML="<span>Energy Saving:</span> "+(D<=90?"Excellent":D<=240?"Good":"Bad"),d.style.color=D<=90?"#FFFFFF":D<=240?"#FFD700":"#FF0000",t.addEventListener("touchstart",(e=>{x=e.touches[0].clientX,E=e.touches[0].clientY,dragStarted=!1,S=!1}),{passive:!0}),t.addEventListener("touchmove",(e=>{const t=e.touches[0].clientX-x,n=e.touches[0].clientY-E;if(!dragStarted){if(Math.abs(n)>Math.abs(t))return void(S=!1);S=!0,dragStarted=!0}S&&(e.preventDefault(),I(e.touches[0].clientX))}),{passive:!1}),t.addEventListener("touchend",(()=>{S=!1,dragStarted=!1,o.style.display="none",s.style.opacity="1",a.style.display="none"})),t.addEventListener("mousemove",(e=>I(e.clientX))),t.addEventListener("mouseleave",(()=>{o.style.display="none",s.style.opacity="1",a.style.display="none"}))}function formatCost(e){return`${(100*e).toFixed(1)}p`}function fetchUptimeData(){const e=document.getElementById("chart-spinner");e.style.display="block",fetch("/uptime-data").then((e=>e.json())).then((e=>{updateChart(e)})).finally((()=>{e.style.display="none"}))}function resetUptime(){fetch("/reset-uptime",{method:"POST"}).then((()=>{fetchUptimeData(),alert("Uptime history has been reset!")})).catch((e=>{console.error("Reset failed:",e),alert("Failed to reset uptime.")}))}document.querySelectorAll('input[name="view-mode"]').forEach((e=>{e.value===currentChartMode&&(e.checked=!0),e.addEventListener("change",(()=>{currentChartMode=document.querySelector('input[name="view-mode"]:checked').value,localStorage.setItem("viewMode",currentChartMode),fetchUptimeData()}))})),document.addEventListener("DOMContentLoaded",(()=>{fetchUptimeData(),setInterval(fetchUptimeData,6e4)})),document.getElementById("freshRolloverBtn").addEventListener("click",(()=>{const e=document.getElementById("rolloverStatus");e.textContent="⏳ Triggering...",fetch("/force-rollover",{method:"POST"}).then((()=>{e.textContent="✅ Rollover complete",setTimeout((()=>e.textContent=""),3e3)})).catch((t=>{console.error("❌ Rollover failed:",t),e.textContent="❌ Rollover failed"}))}));
